/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { combineLatest } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { PageIterator } from '../iterator/page-iterator';
import { makeDispatchers } from '../store/actions';
import { contextSelectors } from '../store/selectors';
import { defaultPaginationContextState, } from '../store/state';
// assumes paginator reducer is plugged in
/**
 * This is a pagination context usable with Redux, ngrx, or
 * any other similar implementations. It writes to, but does
 * not read from the store. It assumes:
 * 1. `dispatch` dispatches an action to the store
 * 2. TODO this library's reducer has been installed
 * @template Entity
 */
export class StorePaginationContext {
    /**
     * @param {?} contextId
     * @param {?} paginationFunction
     * @param {?} dispatch
     * @param {?} onReceivePage
     * @param {?} state$
     * @param {?} entityMap$
     */
    constructor(
    // Arbitrary. For now, only use one ReduxLikePaginationContext per contextId
    contextId, 
    // For requesting the pages
    paginationFunction, 
    // Dispatch an action meant for the PaginationReducer
    dispatch, onReceivePage, state$, entityMap$) {
        this.onReceivePage = onReceivePage;
        this.contextState = defaultPaginationContextState;
        this[Symbol.asyncIterator] = (/**
         * @return {?}
         */
        () => this.pageIterator[Symbol.asyncIterator]);
        this.contextState$ = state$.pipe(map((/**
         * @param {?} state
         * @return {?}
         */
        state => state ? state.contexts[contextId] : defaultPaginationContextState)));
        this.subscription = this.contextState$.subscribe((/**
         * @param {?} contextState
         * @return {?}
         */
        contextState => {
            this.contextState = contextState;
        }));
        this.dispatchers = makeDispatchers(contextId, dispatch);
        this.dispatchers.ResetPaginationState();
        this.pageIterator = new PageIterator(paginationFunction);
        this.entityMap$ = entityMap$.pipe(shareReplay(1));
        // wait until next event loop in case of setup time
        setTimeout((/**
         * @return {?}
         */
        () => this.nextPage()), 0);
    }
    /**
     * @return {?}
     */
    getNextPageP() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const nextPageLoaded = contextSelectors.nextPageLoaded(this.contextState);
            if (nextPageLoaded) {
                this.incrementCurrentPage();
                return;
            }
            if (contextSelectors.done(this.contextState)) {
                throw new Error('Cannot get more pages after becoming done');
            }
            this.dispatchers.GetNextPage();
            /** @type {?} */
            const page = yield this.pageIterator.getNextPage();
            this.onReceivePage(page);
            if (!page) {
                throw new Error('bad page in getNextPageP');
            }
            /** @type {?} */
            const entityIds = page.map((/**
             * @param {?} __0
             * @return {?}
             */
            ({ id }) => id));
            if (!entityIds.length) {
                this.dispatchers.GetNextPageEmpty();
            }
            else {
                this.dispatchers.GetNextPageSuccess(entityIds, this.pageIterator.done);
            }
            return page;
        });
    }
    /**
     * @return {?}
     */
    nextPage() {
        this.getNextPageP();
    }
    /**
     * @return {?}
     */
    prevPage() {
        if (this.contextState.currentPage <= 0) {
            throw new Error('Cannot go back from page 0');
        }
        this.dispatchers.PrevPage();
    }
    /**
     * @private
     * @return {?}
     */
    incrementCurrentPage() {
        this.dispatchers.NextPage();
    }
    /**
     * @return {?}
     */
    get currentPage$() {
        return combineLatest(this.entityMap$, this.contextState$).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        ([entityMap, contextState]) => {
            /** @type {?} */
            const currentPageIds = contextSelectors.currentPageIds(contextState);
            if (!currentPageIds) {
                return null;
            }
            return currentPageIds.map((/**
             * @param {?} entityId
             * @return {?}
             */
            entityId => entityMap[entityId]));
        })));
    }
    /**
     * @return {?}
     */
    destroy() {
        this.subscription.unsubscribe();
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.pageIterator;
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.dispatchers;
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.contextState;
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.contextState$;
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.entityMap$;
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.subscription;
    /* Skipping unnamed member:
    [Symbol.asyncIterator] = () => this.pageIterator[Symbol.asyncIterator];*/
    /**
     * @type {?}
     * @private
     */
    StorePaginationContext.prototype.onReceivePage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUtcGFnaW5hdGlvbi1jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmdyeC1kYXRhLXBhZ2luYXRpb24vIiwic291cmNlcyI6WyJsaWIvcGFnaW5hdGlvbi9zdG9yZS1pbnRlcmZhY2VzL3N0b3JlLXBhZ2luYXRpb24tY29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQTRCLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE9BQU8sRUFBRSxlQUFlLEVBQXFCLE1BQU0sa0JBQWtCLENBQUM7QUFDdEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDdEQsT0FBTyxFQUNMLDZCQUE2QixHQUc5QixNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7O0FBV3hCLE1BQU0sT0FBTyxzQkFBc0I7Ozs7Ozs7OztJQVFqQztJQUNFLDRFQUE0RTtJQUM1RSxTQUFpQjtJQUVqQiwyQkFBMkI7SUFDM0Isa0JBQThDO0lBRTlDLHFEQUFxRDtJQUNyRCxRQUE2QyxFQUdyQyxhQUEyQyxFQUVuRCxNQUFtQyxFQUNuQyxVQUF5QztRQUhqQyxrQkFBYSxHQUFiLGFBQWEsQ0FBOEI7UUFoQjdDLGlCQUFZLEdBQUcsNkJBQTZCLENBQUM7UUF5R3JELEtBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQzs7O1FBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQUM7UUFwRnJFLElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FDOUIsR0FBRzs7OztRQUFDLEtBQUssQ0FBQyxFQUFFLENBQ1YsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFD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LENBQUM7YUFDYjtZQUNELE9BQU8sY0FBYyxDQUFDLEdBQUc7Ozs7WUFBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBQyxDQUFDO1FBQzdELENBQUMsRUFBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7O0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbEMsQ0FBQztDQUdGOzs7Ozs7SUE1R0MsOENBQTJDOzs7OztJQUMzQyw2Q0FBd0Q7Ozs7O0lBQ3hELDhDQUFxRDs7Ozs7SUFDckQsK0NBQTBEOzs7OztJQUMxRCw0Q0FBa0Q7Ozs7O0lBQ2xELDhDQUFtQzs7Ozs7OztJQWFqQywrQ0FBbUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBbnlFbnRpdHksIEVudGl0eU1hcCB9IGZyb20gJy4uL2VudGl0eSc7XG5pbXBvcnQgeyBQYWdlSXRlcmF0b3IgfSBmcm9tICcuLi9pdGVyYXRvci9wYWdlLWl0ZXJhdG9yJztcbmltcG9ydCB7IFBhZ2luYXRpb25GdW5jdGlvbiB9IGZyb20gJy4uL2l0ZXJhdG9yL3BhZ2luYXRpb24tZnVuY3Rpb24nO1xuaW1wb3J0IHsgbWFrZURpc3BhdGNoZXJzLCBQYWdpbmF0aW9uQWN0aW9uVCB9IGZyb20gJy4uL3N0b3JlL2FjdGlvbnMnO1xuaW1wb3J0IHsgY29udGV4dFNlbGVjdG9ycyB9IGZyb20gJy4uL3N0b3JlL3NlbGVjdG9ycyc7XG5pbXBvcnQge1xuICBkZWZhdWx0UGFnaW5hdGlvbkNvbnRleHRTdGF0ZSxcbiAgUGFnaW5hdGlvbkNvbnRleHRTdGF0ZSxcbiAgUGFnaW5hdGlvblN0YXRlLFxufSBmcm9tICcuLi9zdG9yZS9zdGF0ZSc7XG5cbi8vIGFzc3VtZXMgcGFnaW5hdG9yIHJlZHVjZXIgaXMgcGx1Z2dlZCBpblxuXG4vKipcbiAqIFRoaXMgaXMgYSBwYWdpbmF0aW9uIGNvbnRleHQgdXNhYmxlIHdpdGggUmVkdXgsIG5ncngsIG9yXG4gKiBhbnkgb3RoZXIgc2ltaWxhciBpbXBsZW1lbnRhdGlvbnMuIEl0IHdyaXRlcyB0bywgYnV0IGRvZXNcbiAqIG5vdCByZWFkIGZyb20gdGhlIHN0b3JlLiBJdCBhc3N1bWVzOlxuICogMS4gYGRpc3BhdGNoYCBkaXNwYXRjaGVzIGFuIGFjdGlvbiB0byB0aGUgc3RvcmVcbiAqIDIuIFRPRE8gdGhpcyBsaWJyYXJ5J3MgcmVkdWNlciBoYXMgYmVlbiBpbnN0YWxsZWRcbiAqL1xuZXhwb3J0IGNsYXNzIFN0b3JlUGFnaW5hdGlvbkNvbnRleHQ8RW50aXR5IGV4dGVuZHMgQW55RW50aXR5PiB7XG4gIHByaXZhdGUgcGFnZUl0ZXJhdG9yOiBQYWdlSXRlcmF0b3I8RW50aXR5PjtcbiAgcHJpdmF0ZSBkaXNwYXRjaGVyczogUmV0dXJuVHlwZTx0eXBlb2YgbWFrZURpc3BhdGNoZXJzPjtcbiAgcHJpdmF0ZSBjb250ZXh0U3RhdGUgPSBkZWZhdWx0UGFnaW5hdGlvbkNvbnRleHRTdGF0ZTtcbiAgcHJpdmF0ZSBjb250ZXh0U3RhdGUkOiBPYnNlcnZhYmxlPFBhZ2luYXRpb25Db250ZXh0U3RhdGU+O1xuICBwcml2YXRlIGVudGl0eU1hcCQ6IE9ic2VydmFibGU8RW50aXR5TWFwPEVudGl0eT4+O1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIC8vIEFyYml0cmFyeS4gRm9yIG5vdywgb25seSB1c2Ugb25lIFJlZHV4TGlrZVBhZ2luYXRpb25Db250ZXh0IHBlciBjb250ZXh0SWRcbiAgICBjb250ZXh0SWQ6IHN0cmluZyxcblxuICAgIC8vIEZvciByZXF1ZXN0aW5nIHRoZSBwYWdlc1xuICAgIHBhZ2luYXRpb25GdW5jdGlvbjogUGFnaW5hdGlvbkZ1bmN0aW9uPEVudGl0eT4sXG5cbiAgICAvLyBEaXNwYXRjaCBhbiBhY3Rpb24gbWVhbnQgZm9yIHRoZSBQYWdpbmF0aW9uUmVkdWNlclxuICAgIGRpc3BhdGNoOiAoYWN0aW9uOiBQYWdpbmF0aW9uQWN0aW9uVCkgPT4gdm9pZCxcblxuICAgIC8vIEFsbG93IHRoZSBwcm9ncmFtbWVyIHRvIHN0b3JlIGVudGl0aWVzIGFzIHRoZXkgbGlrZVxuICAgIHByaXZhdGUgb25SZWNlaXZlUGFnZTogKGVudGl0aWVzOiBFbnRpdHlbXSkgPT4gdm9pZCxcblxuICAgIHN0YXRlJDogT2JzZXJ2YWJsZTxQYWdpbmF0aW9uU3RhdGU+LFxuICAgIGVudGl0eU1hcCQ6IE9ic2VydmFibGU8RW50aXR5TWFwPEVudGl0eT4+LFxuICApIHtcbiAgICB0aGlzLmNvbnRleHRTdGF0ZSQgPSBzdGF0ZSQucGlwZShcbiAgICAgIG1hcChzdGF0ZSA9PlxuICAgICAgICBzdGF0ZSA/IHN0YXRlLmNvbnRleHRzW2NvbnRleHRJZF0gOiBkZWZhdWx0UGFnaW5hdGlvbkNvbnRleHRTdGF0ZSxcbiAgICAgICksXG4gICAgKTtcblxuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5jb250ZXh0U3RhdGUkLnN1YnNjcmliZShjb250ZXh0U3RhdGUgPT4ge1xuICAgICAgdGhpcy5jb250ZXh0U3RhdGUgPSBjb250ZXh0U3RhdGU7XG4gICAgfSk7XG5cbiAgICB0aGlzLmRpc3BhdGNoZXJzID0gbWFrZURpc3BhdGNoZXJzKGNvbnRleHRJZCwgZGlzcGF0Y2gpO1xuICAgIHRoaXMuZGlzcGF0Y2hlcnMuUmVzZXRQYWdpbmF0aW9uU3RhdGUoKTtcbiAgICB0aGlzLnBhZ2VJdGVyYXRvciA9IG5ldyBQYWdlSXRlcmF0b3IocGFnaW5hdGlvbkZ1bmN0aW9uKTtcblxuICAgIHRoaXMuZW50aXR5TWFwJCA9IGVudGl0eU1hcCQucGlwZShzaGFyZVJlcGxheSgxKSk7XG5cbiAgICAvLyB3YWl0IHVudGlsIG5leHQgZXZlbnQgbG9vcCBpbiBjYXNlIG9mIHNldHVwIHRpbWVcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMubmV4dFBhZ2UoKSwgMCk7XG4gIH1cblxuICBhc3luYyBnZXROZXh0UGFnZVAoKTogUHJvbWlzZTxFbnRpdHlbXT4ge1xuICAgIGNvbnN0IG5leHRQYWdlTG9hZGVkID0gY29udGV4dFNlbGVjdG9ycy5uZXh0UGFnZUxvYWRlZCh0aGlzLmNvbnRleHRTdGF0ZSk7XG4gICAgaWYgKG5leHRQYWdlTG9hZGVkKSB7XG4gICAgICB0aGlzLmluY3JlbWVudEN1cnJlbnRQYWdlKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGNvbnRleHRTZWxlY3RvcnMuZG9uZSh0aGlzLmNvbnRleHRTdGF0ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGdldCBtb3JlIHBhZ2VzIGFmdGVyIGJlY29taW5nIGRvbmUnKTtcbiAgICB9XG5cbiAgICB0aGlzLmRpc3BhdGNoZXJzLkdldE5leHRQYWdlKCk7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMucGFnZUl0ZXJhdG9yLmdldE5leHRQYWdlKCk7XG4gICAgdGhpcy5vblJlY2VpdmVQYWdlKHBhZ2UpO1xuXG4gICAgaWYgKCFwYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JhZCBwYWdlIGluIGdldE5leHRQYWdlUCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGVudGl0eUlkcyA9IHBhZ2UubWFwKCh7IGlkIH0pID0+IGlkKTtcblxuICAgIGlmICghZW50aXR5SWRzLmxlbmd0aCkge1xuICAgICAgdGhpcy5kaXNwYXRjaGVycy5HZXROZXh0UGFnZUVtcHR5KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlzcGF0Y2hlcnMuR2V0TmV4dFBhZ2VTdWNjZXNzKFxuICAgICAgICBlbnRpdHlJZHMsXG4gICAgICAgIHRoaXMucGFnZUl0ZXJhdG9yLmRvbmUsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBwYWdlO1xuICB9XG5cbiAgbmV4dFBhZ2UoKSB7XG4gICAgdGhpcy5nZXROZXh0UGFnZVAoKTtcbiAgfVxuXG4gIHByZXZQYWdlKCkge1xuICAgIGlmICh0aGlzLmNvbnRleHRTdGF0ZS5jdXJyZW50UGFnZSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBnbyBiYWNrIGZyb20gcGFnZSAwJyk7XG4gICAgfVxuICAgIHRoaXMuZGlzcGF0Y2hlcnMuUHJldlBhZ2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5jcmVtZW50Q3VycmVudFBhZ2UoKSB7XG4gICAgdGhpcy5kaXNwYXRjaGVycy5OZXh0UGFnZSgpO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRQYWdlJCgpOiBPYnNlcnZhYmxlPEVudGl0eVtdIHwgbnVsbD4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KHRoaXMuZW50aXR5TWFwJCwgdGhpcy5jb250ZXh0U3RhdGUkKS5waXBlKFxuICAgICAgbWFwKChbZW50aXR5TWFwLCBjb250ZXh0U3RhdGVdKSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYWdlSWRzID0gY29udGV4dFNlbGVjdG9ycy5jdXJyZW50UGFnZUlkcyhjb250ZXh0U3RhdGUpO1xuICAgICAgICBpZiAoIWN1cnJlbnRQYWdlSWRzKSB7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN1cnJlbnRQYWdlSWRzLm1hcChlbnRpdHlJZCA9PiBlbnRpdHlNYXBbZW50aXR5SWRdKTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdID0gKCkgPT4gdGhpcy5wYWdlSXRlcmF0b3JbU3ltYm9sLmFzeW5jSXRlcmF0b3JdO1xufVxuIl19